import{r as t,j as e}from"./index-CeHBmUBv.js";import{a as v}from"./index-NIGUFBhG.js";function C({setLogged:f}){const[r,p]=t.useState(""),[i,j]=t.useState(""),[o,d]=t.useState(!1),[h,m]=t.useState(!1),[c,a]=t.useState(!1),x=async()=>{d(!0);try{const u=(await v.post("https://auth.dnjs.lk/api/login",{email:r,password:i})).data.access_token;c?(localStorage.setItem("access_token",u),localStorage.setItem("signedin","true")):(sessionStorage.setItem("access_token",u),sessionStorage.setItem("signedin","true")),f(!0),m(!1),localStorage.setItem("access_token",u),console.log(u)}catch(s){d(!1),console.log("Error:",s.response?.data||s.message),m("Login in unsuccessful"),f(!1)}finally{d(!1)}};return t.useEffect(()=>{const s=localStorage.getItem("rememberMe");s!==null&&a(s==="true")},[]),e.jsxs("div",{children:[e.jsx("input",{type:"text",placeholder:"Enter email",value:r,onChange:s=>p(s.target.value),disabled:o}),e.jsx("br",{}),e.jsx("input",{type:"password",placeholder:"Enter password",value:i,onChange:s=>j(s.target.value),disabled:o}),e.jsx("br",{}),e.jsx("p",{onChange:x,children:h}),e.jsxs("span",{children:[e.jsx("input",{type:"checkbox",checked:c,onChange:()=>{const s=!c;a(s),localStorage.setItem("rememberMe",s)}}),"Keep me logged in"]}),e.jsx("br",{}),e.jsx("button",{onClick:x,style:{margin:"10px",color:"cyan"},disabled:o,children:o?"Loging In...":"Login"})]})}function E({setLogged:f}){const[r,p]=t.useState(null),[i,j]=t.useState(!1),[o,d]=t.useState(""),[h,m]=t.useState(""),[c,a]=t.useState(!1),[x,s]=t.useState(!1),[u,S]=t.useState(!1),[k,y]=t.useState("");t.useEffect(()=>{const n=localStorage.getItem("access_token")||sessionStorage.getItem("access_token");v.get("https://auth.dnjs.lk/api/user",{headers:{Authorization:`Bearer ${n}`}}).then(l=>{p(l.data),console.log(l.data)}).catch(l=>{setError("Failed to fetch data properly"),console.error(l)})},[]);const g=async()=>{const n=localStorage.getItem("access_token")||sessionStorage.getItem("access_token");j(!0);try{await v.post("https://auth.dnjs.lk/api/logout",{},{headers:{Authorization:`Bearer ${n}`}}),localStorage.removeItem("access_token"),localStorage.removeItem("signedin"),sessionStorage.removeItem("access_token"),sessionStorage.removeItem("signedin"),f(!1),console.log("Logout Successful")}catch{console.error("Logout failed")}finally{j(!0)}},w=async()=>{const n=localStorage.getItem("access_token")||sessionStorage.getItem("access_token");a(!0),s(!1);const l={name:o?.trim()===""?r.name:o,description:h??r.description};try{await v.put("https://auth.dnjs.lk/api/user",l,{headers:{Authorization:`Bearer ${n}`}}),a(!0),p(b=>({...b,name:l.name,description:l.description}))}catch(b){console.error("Error:",b)}finally{a(!1)}};return t.useEffect(()=>{r&&(d(n=>n||r.name||""),m(n=>n||r.description||""))},[r]),e.jsx("div",{children:x?e.jsx(I,{name:o,setName:d,description:h,setDescription:m,handleSave:w,loading:c,back:()=>s(!1),setData:p}):u?e.jsx(_,{password:k,setPassword:y,close:()=>S(!1)}):e.jsxs("div",{children:[e.jsx("h3",{children:"You have now logged in!"}),e.jsxs("p",{children:["Name: ",r?.name]}),e.jsxs("p",{children:["Email: ",r?.email]}),e.jsx("img",{src:r?.avatar,alt:"User Avatar",style:{borderRadius:"50%",width:"100px",height:"100px",objectFit:"cover"}}),e.jsxs("p",{children:["Subscribed: ",r?.subscribed?"Yes":"No"]}),e.jsxs("p",{children:["Description: ",r?.description]}),e.jsx("button",{onClick:()=>s(!0),style:{margin:"10px",color:"cyan"},children:"Edit Profile"}),e.jsx("br",{}),e.jsx("button",{onClick:()=>S(!0),children:"Change Password"}),e.jsx("br",{}),e.jsx("button",{onClick:g,disabled:i,style:{margin:"10px",color:"red"},children:"Log out"})]})})}function I(f){const{name:r,setName:p,description:i,setDescription:j,handleSave:o,loading:d,back:h,setData:m}=f,[c,a]=t.useState(null),[x,s]=t.useState(!1),[u,S]=t.useState(!1),[k,y]=t.useState(""),g=n=>{const l=n.target.files?.[0];l&&l.type.startsWith("image/")?(S(!1),s(!1),a(l),y("")):y("Select valid image file")},w=async()=>{if(!c)return y("No image selected");const n=localStorage.getItem("access_token")||sessionStorage.getItem("access_token"),l=new FormData;l.append("avatar",c),s(!0),S(!1);try{await v.post("https://auth.dnjs.lk/api/avatar",l,{headers:{Authorization:`Bearer ${n}`,"Content-type":"multipart/form-data"}}),m(b=>({...b,avatar:URL.createObjectURL(c)})),S(!0)}catch(b){console.error("Upload failed",b)}finally{s(!1)}};return e.jsxs("div",{children:[e.jsx("h4",{children:"Edit Your Profile"}),e.jsx("input",{value:r,onChange:n=>{p(n.target.value)},type:"text",placeholder:"Change Name"}),e.jsx("br",{}),e.jsx("input",{value:i,onChange:n=>j(n.target.value),type:"text",placeholder:"Change Description",style:{margin:"10px"}}),e.jsx("br",{}),c&&e.jsx("img",{src:URL.createObjectURL(c),alt:"Preview",style:{width:"100px",height:"100px",borderRadius:"50%",objectFit:"cover",margin:"10px"}}),e.jsx("br",{}),e.jsx("input",{type:"file",accept:"image/",onChange:g}),k&&e.jsx("p",{style:{color:"red"},children:k}),e.jsx("button",{onClick:w,disabled:x||u,children:x?"Uploading...":u?"Uploaded":"Upload"}),e.jsx("br",{}),e.jsx("button",{onClick:o,disabled:d,style:{margin:"10px",color:"chartreuse"},children:d?"Saving...":"Save"}),e.jsx("button",{onClick:h,style:{margin:"10px",color:"cyan"},children:"Go Back"})]})}function _({close:f,password:r,setPassword:p}){const[i,j]=t.useState(""),[o,d]=t.useState(""),[h,m]=t.useState(!1),[c,a]=t.useState(""),[x,s]=t.useState(""),[u,S]=t.useState(""),k=()=>{const g=i.trim(),w=o.trim(),n=u.trim();return!g||!w||!n===""?(a("All fields are required"),!1):w!==n?(a("New password & re-entered password doesnt match"),!1):o.length<8?(a("must be at least 8 characters long"),!1):o.length>40?(a("must not exceed 40 characters"),!1):/[0-9]/.test(o)?/[*/@#$-]/.test(o)?/[a-z]/.test(o)?/[A-Z]/.test(o)?(a(""),!0):(a("must contain at least one uppercase letter"),!1):(a("must contain at least one lowercase letter"),!1):(a("must contain at least one special character (*/-@#$)"),!1):(a("must contain at least one numeric character"),!1)},y=async g=>{s("");const w=localStorage.getItem("access_token")||sessionStorage.getItem("access_token");if(m(!0),!k()){m(!1);return}try{await v.put("https://auth.dnjs.lk/api/password",{old_password:i,new_password:o},{headers:{Authorization:`Bearer ${w}`}}),p(o),d(""),S(""),j(""),a(""),s("Password Changed")}catch(n){a(i!==r?"Current password is incorrect":"Failed to update password. Try again."),console.error("Error in changing password:",n)}finally{m(!1)}};return e.jsxs("div",{children:[e.jsx("input",{placeholder:"Enter current password",type:"password",value:i,onChange:g=>{j(g.target.value),s(""),a("")},style:{margin:"10px"}}),e.jsx("br",{}),e.jsx("input",{placeholder:"Enter new password",value:o,type:"password",onChange:g=>{d(g.target.value),s(""),a("")},style:{margin:"10px"}}),e.jsx("br",{}),e.jsx("input",{placeholder:"Re-Enter new password",value:u,type:"password",onChange:g=>{S(g.target.value),s(""),a("")},style:{margin:"10px"}}),e.jsx("br",{}),c&&e.jsx("p",{style:{color:"red"},children:c}),x&&e.jsx("p",{style:{color:"green"},children:x}),e.jsx("button",{onClick:y,style:{margin:"10px",color:"cyan"},disabled:h,children:h?"Updating...":"Change Password"}),e.jsx("button",{onClick:f,style:{margin:"10px",color:"red"},children:"Close"})]})}function U(){const[f,r]=t.useState(!1);return t.useEffect(()=>{const p=localStorage.getItem("access_token")||sessionStorage.getItem("access_token"),i=localStorage.getItem("signedin")||sessionStorage.getItem("signedin");r(!!(p&&i==="true"))},[]),f?e.jsx(E,{setLogged:r}):e.jsx(C,{setLogged:r})}export{U as default};
